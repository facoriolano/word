<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Slide Presenter AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              gray: {
                850: '#1f2937',
                900: '#111827',
                950: '#0B0F19',
              },
              brand: {
                blue: '#3b82f6',
                accent: '#f59e0b'
              }
            },
            fontFamily: {
              sans: ['"Inter"', 'sans-serif'],
            }
          }
        }
      }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      body { margin: 0; overflow: hidden; background-color: #0B0F19; color: #e5e7eb; font-family: 'Inter', sans-serif; }
      
      /* Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #111827; }
      ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
      
      .slide-preview {
        aspect-ratio: 16/9;
        overflow: hidden;
      }
    </style>

    <!-- SETUP PROCESS ENV -->
    <script>
      window.process = {
        env: {
          // TODO: Replace with your actual API Key for AI features
          API_KEY: 'YOUR_API_KEY_HERE' 
        }
      };
    </script>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0?dev",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?dev",
    "lucide-react": "https://esm.sh/lucide-react@0.378.0?dev",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root" class="h-screen w-screen flex flex-col"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Presentation, FileText, Upload, MonitorPlay, 
        ChevronLeft, ChevronRight, Sparkles, X, Menu,
        Layout, Play
      } from 'lucide-react';
      import { GoogleGenAI } from "@google/genai";

      // --- CONSTANTS ---
      const INITIAL_DECK = `Welcome to Slide Presenter AI
This is the title slide.
Use the arrow keys to navigate.
---
Features
1. Dual Screen Support
2. Text-based Editing
3. AI Deck Generation
4. Real-time Preview
---
How to Use
- Click "Open TXT" to load your script.
- Separate slides with "---".
- Click "Start Presentation" to open the viewer window.
- Move this window to your laptop screen, and the viewer to the projector.
---
AI Generation
Click the "AI Generate" button to create a slide deck about any topic instantly.
`;

      // --- AI SERVICE ---
      const generateSlideDeck = async (topic) => {
        const apiKey = window.process?.env?.API_KEY;
        if (!apiKey || apiKey === 'YOUR_API_KEY_HERE') {
          alert("API Key is missing. Please edit index.html to add your Google Gemini API Key.");
          return null;
        }

        const ai = new GoogleGenAI({ apiKey });
        const modelId = 'gemini-2.5-flash';
        
        const prompt = `Create a presentation slide deck about: "${topic}".
        Format the output specifically for a slide parser:
        - Separate each slide with "---" on a new line.
        - The first line of each slide is the Title (Header).
        - The rest is the content.
        - Use simple plain text or simple HTML tags (<br>, <ul>, <li>, <b>) for formatting.
        - Create at least 5 slides.
        - Do not include markdown code blocks (like \`\`\`). Just raw text.`;

        try {
          const response = await ai.models.generateContent({
            model: modelId,
            contents: prompt,
          });
          return response.text;
        } catch (error) {
          console.error("AI Error:", error);
          alert("Failed to generate deck. See console.");
          return null;
        }
      };

      // --- HELPER FUNCTIONS ---
      const parseSlides = (text) => {
        if (!text) return [];
        return text.split('---').map(s => {
          const clean = s.trim();
          const lines = clean.split('\n');
          const title = lines[0] ? lines[0].trim() : '(No Title)';
          const body = lines.slice(1).join('\n').trim();
          return { title, body, fullText: clean };
        }).filter(s => s.fullText.length > 0);
      };

      const escapeHTML = (str) => {
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;')
          .replace(/\n/g, '<br>');
      };

      // --- POPUP HTML TEMPLATE ---
      const POPUP_HTML_TEMPLATE = `
        <html>
          <head>
            <title>Presentation Viewer</title>
            <style>
              body {
                background-color: #000;
                color: #fff;
                font-family: 'Segoe UI', sans-serif;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                padding: 40px;
                box-sizing: border-box;
                text-align: center;
              }
              #slide-container {
                max-width: 90%;
              }
              h1 { font-size: 4vw; margin-bottom: 2vh; color: #fbbf24; text-transform: uppercase; letter-spacing: 2px; }
              p, div { font-size: 2.5vw; line-height: 1.5; color: #e5e7eb; }
              ul { text-align: left; display: inline-block; font-size: 2vw; }
              li { margin-bottom: 1vh; }
            </style>
          </head>
          <body>
            <div id="slide-container">
              <h1 id="title">Waiting for slides...</h1>
              <div id="content"></div>
            </div>
            <script>
              window.addEventListener('message', (event) => {
                if (event.data) {
                  const { title, body } = event.data;
                  document.getElementById('title').innerHTML = title || '';
                  
                  // Simple formatter for body
                  let formattedBody = body || '';
                  // If body doesn't look like HTML, treat newlines as <br>
                  if (!formattedBody.includes('<')) {
                     formattedBody = formattedBody.replace(/\\n/g, '<br>');
                  }
                  
                  document.getElementById('content').innerHTML = formattedBody;
                }
              });

              // Forward key events to opener
              document.addEventListener('keydown', (e) => {
                if(window.opener) {
                  window.opener.postMessage({ type: 'KEYDOWN', key: e.key }, '*');
                }
              });
            </script>
          </body>
        </html>
      `;

      // --- COMPONENTS ---

      const App = () => {
        const [rawText, setRawText] = useState(INITIAL_DECK);
        const [slides, setSlides] = useState(parseSlides(INITIAL_DECK));
        const [currentIndex, setCurrentIndex] = useState(0);
        const [popupWindow, setPopupWindow] = useState(null);
        const [isAiLoading, setIsAiLoading] = useState(false);
        const [showAiModal, setShowAiModal] = useState(false);
        const fileInputRef = useRef(null);

        // Sync parsing when raw text changes
        useEffect(() => {
          setSlides(parseSlides(rawText));
        }, [rawText]);

        // Sync with Popup when index or slides change
        useEffect(() => {
          if (popupWindow && !popupWindow.closed) {
            const current = slides[currentIndex];
            if (current) {
              popupWindow.postMessage({ 
                title: current.title, 
                body: current.body 
              }, '*');
            }
          }
        }, [currentIndex, slides, popupWindow]);

        // Listen for keys from Popup
        useEffect(() => {
          const handleMessage = (event) => {
            if (event.data?.type === 'KEYDOWN') {
              handleNavigation(event.data.key);
            }
          };
          window.addEventListener('message', handleMessage);
          return () => window.removeEventListener('message', handleMessage);
        }, [slides, currentIndex]); // Dependencies important for handleNavigation closure

        // Keyboard Navigation (Main Window)
        useEffect(() => {
          const handleKeyDown = (e) => handleNavigation(e.key);
          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }, [currentIndex, slides]);

        const handleNavigation = (key) => {
          if (key === 'ArrowRight' || key === 'ArrowDown' || key === ' ') {
            setCurrentIndex(prev => Math.min(prev + 1, slides.length - 1));
          } else if (key === 'ArrowLeft' || key === 'ArrowUp') {
            setCurrentIndex(prev => Math.max(prev - 1, 0));
          }
        };

        const handleOpenFile = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            setRawText(ev.target.result);
            setCurrentIndex(0);
          };
          reader.readAsText(file);
        };

        const startPresentation = () => {
          if (popupWindow && !popupWindow.closed) {
            popupWindow.focus();
          } else {
            const win = window.open('', 'PresentationViewer', 'width=1024,height=768');
            if (win) {
              win.document.write(POPUP_HTML_TEMPLATE);
              win.document.close();
              setPopupWindow(win);
              
              // Initial push after a slight delay to ensure load
              setTimeout(() => {
                const current = slides[currentIndex];
                if (current) win.postMessage({ title: current.title, body: current.body }, '*');
              }, 500);
            } else {
              alert("Popup blocked! Please allow popups for this site.");
            }
          }
        };

        const handleAiGenerate = async (topic) => {
          setIsAiLoading(true);
          const result = await generateSlideDeck(topic);
          if (result) {
            setRawText(result);
            setCurrentIndex(0);
            setShowAiModal(false);
          }
          setIsAiLoading(false);
        };

        const currentSlide = slides[currentIndex] || { title: 'End of Deck', body: '' };
        const nextSlide = slides[currentIndex + 1];

        return (
          <div className="flex h-screen bg-gray-950 text-gray-200 overflow-hidden">
            
            {/* --- LEFT SIDEBAR: THUMBNAILS --- */}
            <div className="w-64 flex flex-col border-r border-gray-800 bg-gray-900">
              <div className="p-4 border-b border-gray-800 flex items-center justify-between">
                <h1 className="font-bold text-brand-blue flex items-center gap-2">
                  <Presentation size={20} />
                  Slides
                </h1>
                <span className="text-xs text-gray-500">{slides.length} total</span>
              </div>
              <div className="flex-1 overflow-y-auto p-2 space-y-2">
                {slides.map((slide, idx) => (
                  <div 
                    key={idx}
                    onClick={() => setCurrentIndex(idx)}
                    className={`
                      p-3 rounded-lg cursor-pointer border transition-all
                      ${idx === currentIndex 
                        ? 'bg-blue-900/20 border-brand-blue shadow-lg shadow-blue-900/10' 
                        : 'bg-gray-800 border-gray-700 hover:border-gray-500'
                      }
                    `}
                  >
                    <div className="flex justify-between items-start mb-1">
                      <span className={`text-xs font-bold ${idx === currentIndex ? 'text-brand-blue' : 'text-gray-400'}`}>#{idx + 1}</span>
                    </div>
                    <h4 className="text-sm font-semibold truncate text-gray-100">{slide.title}</h4>
                    <p className="text-xs text-gray-400 truncate mt-1 opacity-70">{slide.body.substring(0, 30)}...</p>
                  </div>
                ))}
              </div>
              
              {/* File Controls */}
              <div className="p-3 border-t border-gray-800 bg-gray-900 grid grid-cols-2 gap-2">
                <input 
                  type="file" 
                  ref={fileInputRef} 
                  className="hidden" 
                  accept=".txt" 
                  onChange={handleOpenFile} 
                />
                <button 
                  onClick={() => fileInputRef.current.click()}
                  className="flex items-center justify-center gap-2 p-2 rounded bg-gray-800 hover:bg-gray-700 text-xs font-medium border border-gray-700 transition-colors"
                >
                  <Upload size={14} /> Open TXT
                </button>
                 <button 
                  onClick={() => setShowAiModal(true)}
                  className="flex items-center justify-center gap-2 p-2 rounded bg-purple-900/30 hover:bg-purple-900/50 text-purple-300 text-xs font-medium border border-purple-800/50 transition-colors"
                >
                  <Sparkles size={14} /> AI Deck
                </button>
              </div>
            </div>

            {/* --- RIGHT MAIN: PREVIEW & CONTROLS --- */}
            <div className="flex-1 flex flex-col h-full relative">
              
              {/* Toolbar */}
              <div className="h-14 border-b border-gray-800 flex items-center justify-between px-6 bg-gray-900/50 backdrop-blur-md z-10">
                <div className="flex items-center gap-4">
                  <h2 className="text-lg font-semibold text-white tracking-wide">
                     {currentSlide.title}
                  </h2>
                </div>
                <div className="flex items-center gap-3">
                  <div className="flex items-center bg-gray-800 rounded-lg p-1 mr-4">
                    <button 
                      onClick={() => handleNavigation('ArrowLeft')}
                      className="p-1.5 hover:bg-gray-700 rounded text-gray-400 hover:text-white transition"
                    >
                      <ChevronLeft size={18} />
                    </button>
                    <span className="mx-3 font-mono text-sm">{currentIndex + 1} / {slides.length}</span>
                    <button 
                      onClick={() => handleNavigation('ArrowRight')}
                      className="p-1.5 hover:bg-gray-700 rounded text-gray-400 hover:text-white transition"
                    >
                      <ChevronRight size={18} />
                    </button>
                  </div>

                  <button 
                    onClick={startPresentation}
                    className={`
                      flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-sm shadow-lg transition-all
                      ${popupWindow && !popupWindow.closed 
                        ? 'bg-green-600 hover:bg-green-700 text-white shadow-green-900/20' 
                        : 'bg-brand-blue hover:bg-blue-600 text-white shadow-blue-900/20'
                      }
                    `}
                  >
                    {popupWindow && !popupWindow.closed ? <MonitorPlay size={16} /> : <Play size={16} />}
                    {popupWindow && !popupWindow.closed ? 'Presenting...' : 'Start Presentation'}
                  </button>
                </div>
              </div>

              {/* Main Workspace */}
              <div className="flex-1 overflow-auto p-8 flex gap-8 items-start justify-center bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-gray-900 via-gray-950 to-gray-950">
                
                {/* Current Slide (Large) */}
                <div className="flex-1 max-w-3xl flex flex-col gap-2">
                  <div className="flex justify-between items-end px-1">
                    <span className="text-sm font-medium text-brand-blue uppercase tracking-wider">Current Slide</span>
                  </div>
                  <div className="aspect-video bg-white text-black rounded-xl shadow-2xl p-8 sm:p-12 flex flex-col overflow-hidden relative border-4 border-gray-800">
                     <h1 className="text-4xl font-bold mb-6 text-gray-900 border-b-4 border-yellow-400 pb-2 inline-block self-start">
                       {currentSlide.title}
                     </h1>
                     <div className="text-xl leading-relaxed whitespace-pre-line text-gray-700">
                       {currentSlide.body}
                     </div>
                  </div>
                </div>

                {/* Next Slide (Teleprompter style) */}
                <div className="w-80 hidden xl:flex flex-col gap-2 opacity-80 sticky top-0">
                   <div className="flex justify-between items-end px-1">
                    <span className="text-sm font-medium text-gray-500 uppercase tracking-wider">Up Next</span>
                  </div>
                  {nextSlide ? (
                    <div className="aspect-video bg-gray-800 rounded-lg border border-gray-700 p-4 flex flex-col overflow-hidden text-gray-400 scale-95 origin-top">
                      <h3 className="font-bold text-lg mb-2 text-gray-300">{nextSlide.title}</h3>
                      <p className="text-xs leading-relaxed line-clamp-6">{nextSlide.body}</p>
                    </div>
                  ) : (
                    <div className="aspect-video bg-gray-800/30 rounded-lg border border-gray-800 border-dashed flex items-center justify-center text-gray-600 text-sm">
                      End of Presentation
                    </div>
                  )}

                  <div className="mt-8 bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                    <h4 className="text-xs font-bold text-gray-400 mb-2 uppercase">Presenter Notes</h4>
                    <p className="text-sm text-gray-300 italic">
                      Remember to pause after the key points.
                      Don't read directly from the slide.
                    </p>
                  </div>
                </div>
              </div>

            </div>

            {/* --- AI MODAL --- */}
            {showAiModal && (
              <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-gray-900 border border-gray-700 p-6 rounded-2xl w-full max-w-md shadow-2xl">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-bold text-white flex items-center gap-2">
                      <Sparkles className="text-purple-400" /> AI Deck Generator
                    </h3>
                    <button onClick={() => setShowAiModal(false)} className="text-gray-500 hover:text-white"><X size={20}/></button>
                  </div>
                  <p className="text-gray-400 text-sm mb-4">Enter a topic, and AI will generate a slide deck for you.</p>
                  <form onSubmit={(e) => { e.preventDefault(); handleAiGenerate(e.target.topic.value); }}>
                    <input 
                      name="topic" 
                      autoFocus 
                      placeholder="e.g. The History of Space Exploration" 
                      className="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-purple-500 outline-none mb-4"
                    />
                    <button 
                      type="submit" 
                      disabled={isAiLoading}
                      className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg transition-colors flex justify-center items-center gap-2"
                    >
                      {isAiLoading ? 'Generating...' : 'Generate Deck'}
                    </button>
                  </form>
                </div>
              </div>
            )}

          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
