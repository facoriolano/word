<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RetroWave Editor</title>
    <meta name="description" content="Smooth Text Editor" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Polyfill for process.env -->
    <script>
      window.process = { env: { API_KEY: '' } };
    </script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              retro: {
                bg: '#1e1e2e',
                surface: '#2a2b3d',
                pink: '#ff79c6',
                cyan: '#8be9fd',
                green: '#50fa7b',
                yellow: '#f1fa8c',
                comment: '#6272a4',
                text: '#f8f8f2',
                red: '#ff5555'
              }
            },
            fontFamily: {
              code: ['"Fira Code"', 'monospace'],
              sans: ['"Fira Code"', 'sans-serif'],
            }
          }
        }
      }
    </script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #1e1e2e;
        color: #f8f8f2;
      }
      #root {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      ::-webkit-scrollbar { width: 10px; height: 10px; }
      ::-webkit-scrollbar-track { background: #1e1e2e; }
      ::-webkit-scrollbar-thumb { background: #44475a; border-radius: 5px; border: 2px solid #1e1e2e; }
      ::-webkit-scrollbar-thumb:hover { background: #6272a4; }
      
      .loading-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #8be9fd;
        font-family: 'Fira Code', monospace;
        transition: opacity 0.5s ease;
      }
    </style>
    
    <!-- STRICT IMPORT MAP - NO CONFLICTS -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
  <body>
    <div id="root">
      <div id="loading-ui" class="loading-screen">
        <p>Loading RetroWave Editor...</p>
        <p style="font-size: 0.8em; color: #6272a4; margin-top: 10px;">Initializing environment...</p>
      </div>
    </div>
    
    <!-- Error Overlay -->
    <div id="error-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e1e2e; color: #ff5555; padding: 20px; font-family: monospace; z-index: 9999;">
      <h2 style="margin-top: 0; color: #ff5555;">System Error</h2>
      <pre id="error-message" style="white-space: pre-wrap; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; border: 1px solid #44475a;"></pre>
      <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #44475a; color: white; border: none; cursor: pointer; border-radius: 4px; font-family: inherit;">Reload System</button>
    </div>

    <!-- Watchdog Script to catch hangs -->
    <script>
      // Global error handlers
      window.onerror = function(msg, url, line, col, error) {
        showError(`Error: ${msg}\nLine: ${line}`);
        return false;
      };
      
      window.onunhandledrejection = function(e) {
        showError(`Promise Rejection: ${e.reason}`);
      };

      function showError(msg) {
        const el = document.getElementById('error-container');
        const txt = document.getElementById('error-message');
        if (el && txt) {
          el.style.display = 'block';
          txt.textContent = msg;
          document.getElementById('loading-ui').style.display = 'none';
        }
      }

      // Timeout watchdog
      setTimeout(() => {
        const root = document.getElementById('root');
        // If the loading text is still there, we assume the app failed to mount silently
        if (root && root.innerText.includes('Loading RetroWave Editor...')) {
           console.warn("Mount timeout reached.");
           // We don't block immediately in case of slow network, but we log it.
           // If it persists for 8 seconds, we show error.
           setTimeout(() => {
             if (root && root.innerText.includes('Loading RetroWave Editor...')) {
               showError("Initialization Timeout.\nThe application took too long to start.\n\nPossible causes:\n1. Network firewall blocking 'esm.sh'.\n2. Browser extensions interfering with scripts.\n\nCheck the browser console (F12) for details.");
             }
           }, 4000);
        }
      }, 4000);
    </script>

    <!-- Application Code -->
    <script type="text/babel" data-type="module">
      import React, { useState, useCallback, useRef, useEffect } from 'react';
      import { createRoot } from 'react-dom/client';
      import { Save, FolderOpen, Wand2, Terminal, Eraser, Sparkles, X } from 'lucide-react';
      import { GoogleGenAI } from '@google/genai';

      // --- Types & Constants ---
      const EditorStatus = {
        IDLE: 'IDLE',
        SAVING: 'SAVING',
        LOADING: 'LOADING',
        AI_THINKING: 'AI_THINKING',
        ERROR: 'ERROR'
      };

      // --- Services ---
      const generateAICompletion = async (currentText, instruction) => {
        const apiKey = window.process?.env?.API_KEY || '';
        
        if (!apiKey) {
          console.warn("API Key not found.");
          await new Promise(resolve => setTimeout(resolve, 800));
          return currentText + "\n\n// [System]: API Key missing.\n// Please configure process.env.API_KEY to use AI features.";
        }

        try {
          const ai = new GoogleGenAI({ apiKey });
          const model = 'gemini-2.5-flash';
          const prompt = `
            You are a helpful coding assistant integrated into a modern text editor.
            User Instruction: ${instruction}
            Current File Content:
            ${currentText}
            Return ONLY the updated or completed text content. Do not include markdown blocks unless requested.
          `;

          const response = await ai.models.generateContent({
            model: model,
            contents: prompt,
          });

          return response.text || "";
        } catch (error) {
          console.error("Gemini API Error:", error);
          throw error;
        }
      };

      // --- Components ---

      const Toolbar = ({ status, fileName, onSave, onOpen, onAIClear, onAIAssist, wordCount }) => {
        const fileInputRef = useRef(null);

        const handleFileChange = (e) => {
          if (e.target.files && e.target.files[0]) {
            onOpen(e.target.files[0]);
          }
          if (fileInputRef.current) fileInputRef.current.value = '';
        };

        return (
          <div className="bg-retro-bg border-b border-retro-surface flex flex-col md:flex-row items-center justify-between p-3 flex-shrink-0 z-40 shadow-sm">
            <div className="flex items-center gap-4 mb-2 md:mb-0">
              <div className="flex items-center gap-2 text-retro-pink font-code text-lg font-bold">
                <Terminal className="w-5 h-5" />
                <span>RetroWave</span>
              </div>
              <div className="hidden md:block h-5 w-[1px] bg-retro-surface mx-2"></div>
              <span className="text-retro-comment font-code text-sm">{fileName}</span>
            </div>

            <div className="flex items-center gap-2">
              <input type="file" accept=".txt,.md,.js,.ts,.json" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
              
              <button onClick={() => fileInputRef.current?.click()} className="group px-4 py-2 bg-retro-surface rounded-md text-retro-cyan font-code text-sm font-medium hover:bg-retro-cyan hover:text-retro-bg transition-all disabled:opacity-50" disabled={status === EditorStatus.AI_THINKING}>
                <span className="flex items-center gap-2"><FolderOpen className="w-4 h-4" /> Open</span>
              </button>

              <button onClick={onSave} className="group px-4 py-2 bg-retro-surface rounded-md text-retro-green font-code text-sm font-medium hover:bg-retro-green hover:text-retro-bg transition-all disabled:opacity-50" disabled={status === EditorStatus.AI_THINKING}>
                <span className="flex items-center gap-2"><Save className="w-4 h-4" /> Save</span>
              </button>
              
              <div className="h-6 w-[1px] bg-retro-surface mx-1"></div>

              <button onClick={onAIClear} className="group px-4 py-2 bg-retro-surface rounded-md text-retro-red font-code text-sm font-medium hover:bg-retro-red hover:text-retro-bg transition-all disabled:opacity-50" disabled={status === EditorStatus.AI_THINKING}>
                <span className="flex items-center gap-2"><Eraser className="w-4 h-4" /> Clear</span>
              </button>

              <button onClick={onAIAssist} className={`group px-4 py-2 rounded-md font-code text-sm font-medium transition-all flex items-center gap-2 shadow-sm ${status === EditorStatus.AI_THINKING ? 'bg-retro-pink text-retro-bg cursor-wait opacity-80' : 'bg-retro-pink text-retro-bg hover:bg-retro-pink/90'}`} disabled={status === EditorStatus.AI_THINKING}>
                <Wand2 className={`w-4 h-4 ${status === EditorStatus.AI_THINKING ? 'animate-spin' : ''}`} />
                {status === EditorStatus.AI_THINKING ? 'Working...' : 'AI Assist'}
              </button>
            </div>
          </div>
        );
      };

      const StatusBar = ({ status, lines, chars }) => {
        const getStatusColor = () => {
          switch (status) {
            case EditorStatus.AI_THINKING: return 'text-retro-pink';
            case EditorStatus.ERROR: return 'text-retro-red';
            case EditorStatus.SAVING: return 'text-retro-green';
            default: return 'text-retro-comment';
          }
        };

        return (
          <div className="h-8 bg-retro-bg border-t border-retro-comment flex-shrink-0 flex items-center justify-between px-4 font-code text-xs select-none z-40">
            <div className="flex items-center gap-4">
              <span className={`uppercase font-bold ${getStatusColor()}`}>[{status}]</span>
            </div>
            <div className="flex items-center gap-6 text-retro-comment">
              <span>Ln {lines}</span>
              <span>Ch {chars}</span>
              <span className="hidden sm:inline">UTF-8</span>
              <span className="hidden sm:inline">TXT</span>
            </div>
          </div>
        );
      };

      const AIPromptModal = ({ isOpen, onClose, onSubmit }) => {
        const [input, setInput] = useState('');
        
        useEffect(() => {
            if (isOpen) {
               setTimeout(() => document.getElementById('ai-input')?.focus(), 50);
            }
        }, [isOpen]);

        if (!isOpen) return null;

        const handleSubmit = (e) => {
          e.preventDefault();
          if (input.trim()) {
            onSubmit(input);
            setInput('');
            onClose();
          }
        };

        return (
          <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
            <div className="relative bg-retro-bg border border-retro-surface w-full max-w-lg shadow-2xl rounded-lg overflow-hidden transform transition-all">
              <div className="bg-retro-surface p-4 border-b border-retro-bg flex justify-between items-center">
                <span className="flex items-center gap-2 text-retro-pink font-bold font-code text-base">
                  <Sparkles className="w-5 h-5"/> AI Assistant
                </span>
                <button onClick={onClose} className="text-retro-comment hover:text-retro-text transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <form onSubmit={handleSubmit} className="p-6">
                <label className="block text-retro-text font-code text-sm mb-3">What would you like the AI to do?</label>
                <textarea 
                  id="ai-input"
                  value={input} 
                  onChange={(e) => setInput(e.target.value)} 
                  className="w-full h-32 bg-retro-bg border border-retro-surface text-retro-text p-4 font-code rounded-md focus:outline-none focus:border-retro-pink focus:ring-1 focus:ring-retro-pink transition-all resize-none text-sm" 
                  placeholder="e.g., 'Refactor this code', 'Add comments'..." 
                />
                <div className="flex justify-end gap-3 mt-6">
                  <button type="button" onClick={onClose} className="px-4 py-2 text-retro-comment font-code text-sm font-medium hover:text-retro-text transition-colors">Cancel</button>
                  <button type="submit" className="px-6 py-2 bg-retro-pink text-retro-bg font-bold font-code text-sm rounded-md hover:bg-retro-pink/90 transition-all shadow-md">Generate</button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const App = () => {
        const [content, setContent] = useState(`// Welcome to RetroWave Editor v1.0
// Styled with the Dracula/Synthwave palette.
// Type away, or ask the AI Oracle for help.

function helloWorld() {
  const greeting = "Hello, World!";
  console.log(greeting);
}
`);
        const [fileName, setFileName] = useState('untitled.txt');
        const [status, setStatus] = useState(EditorStatus.IDLE);
        const [isAIModalOpen, setIsAIModalOpen] = useState(false);
        const [toasts, setToasts] = useState([]);
        
        const textAreaRef = useRef(null);
        const lineNumbersRef = useRef(null);

        const lines = content.split('\n').length;
        const chars = content.length;

        const addToast = (message, type) => {
          const id = Date.now().toString();
          setToasts(prev => [...prev, { id, message, type }]);
          setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
        };

        const handleScroll = () => {
          if (textAreaRef.current && lineNumbersRef.current) {
            lineNumbersRef.current.scrollTop = textAreaRef.current.scrollTop;
          }
        };

        const handleSave = useCallback(() => {
          try {
            setStatus(EditorStatus.SAVING);
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            addToast('File saved successfully!', 'success');
            setStatus(EditorStatus.IDLE);
          } catch (e) {
            console.error(e);
            setStatus(EditorStatus.ERROR);
            addToast('Failed to save file.', 'error');
          }
        }, [content, fileName]);

        const handleOpen = useCallback(async (file) => {
          try {
            setStatus(EditorStatus.LOADING);
            const text = await file.text();
            setContent(text);
            setFileName(file.name);
            addToast(`Opened ${file.name}`, 'success');
            setStatus(EditorStatus.IDLE);
          } catch (e) {
            console.error(e);
            setStatus(EditorStatus.ERROR);
            addToast('Failed to read file.', 'error');
          }
        }, []);

        const handleAIRequest = async (prompt) => {
          try {
            setStatus(EditorStatus.AI_THINKING);
            const result = await generateAICompletion(content, prompt);
            if (result) {
              setContent(result);
              addToast('AI Request completed.', 'success');
            } else {
              addToast('AI returned no content.', 'info');
            }
            setStatus(EditorStatus.IDLE);
          } catch (e) {
            console.error(e);
            setStatus(EditorStatus.ERROR);
            addToast('AI Connection Failed. Check console.', 'error');
          }
        };

        return (
          <div className="h-full flex flex-col bg-retro-bg text-retro-text font-code overflow-hidden relative">
            <div className="fixed top-20 right-4 z-[70] flex flex-col gap-2 pointer-events-none">
              {toasts.map(toast => (
                <div key={toast.id} className={`pointer-events-auto px-4 py-3 rounded shadow-lg font-code text-sm transition-all duration-300 border ${toast.type === 'success' ? 'bg-retro-surface text-retro-green border-retro-green' : toast.type === 'error' ? 'bg-retro-surface text-retro-red border-retro-red' : 'bg-retro-surface text-retro-cyan border-retro-cyan'}`}>
                  {toast.message}
                </div>
              ))}
            </div>

            <Toolbar status={status} fileName={fileName} onSave={handleSave} onOpen={handleOpen} onAIClear={() => setContent('')} onAIAssist={() => setIsAIModalOpen(true)} wordCount={content.split(/\s+/).filter(Boolean).length} />

            <main className="flex-1 flex flex-row min-h-0 relative">
              <div ref={lineNumbersRef} className="bg-retro-bg w-14 flex-shrink-0 flex flex-col items-end py-4 px-3 select-none text-retro-comment text-sm border-r border-retro-surface overflow-hidden">
                {Array.from({ length: Math.min(lines, 2000) }).map((_, i) => (
                  <div key={i} className="leading-6 h-6">{i + 1}</div>
                ))}
              </div>
              <textarea ref={textAreaRef} value={content} onChange={(e) => setContent(e.target.value)} onScroll={handleScroll} className="flex-1 w-full h-full bg-retro-bg text-retro-text p-4 resize-none focus:outline-none leading-6 font-code text-base selection:bg-retro-comment selection:text-white border-0" spellCheck={false} />
            </main>

            <StatusBar status={status} lines={lines} chars={chars} />
            <AIPromptModal isOpen={isAIModalOpen} onClose={() => setIsAIModalOpen(false)} onSubmit={handleAIRequest} />
          </div>
        );
      };

      try {
        const rootElement = document.getElementById('root');
        if (!rootElement) throw new Error("Root element not found");
        const root = createRoot(rootElement);
        root.render(<App />);
      } catch (err) {
        throw err; // Re-throw to be caught by window.onerror
      }
    </script>
  </body>
</html>
