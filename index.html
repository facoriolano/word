<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Code Editor - Dark Theme</title>
<!-- Import Map para carregar a biblioteca Gemini direto do navegador -->
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@0.1.0",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<!-- Fonte JetBrains Mono para ficar igual ao print -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root {
    /* Paleta Dracula Oficial */
    --bg-app: #eef1f5;
    --window-bg: #282a36;     /* Background Principal */
    --fg-primary: #f8f8f2;    /* Texto */
    
    /* Cores de Sintaxe e UI */
    --accent-pink: #ff79c6;
    --accent-cyan: #8be9fd;
    --accent-green: #50fa7b;
    --accent-orange: #ffb86c;
    --accent-purple: #bd93f9;
    --accent-yellow: #f1fa8c;
    --comment: #6272a4;
    
    /* UI */
    --selection: #44475a;
    --current-line: #44475a;
  }

  /* Reset */
  * { box-sizing: border-box; }
  
  html, body {
    height: 100%;
    margin: 0;
    font-family: 'JetBrains Mono', monospace;
    /* Fundo externo neutro/suave para destacar o editor escuro */
    background: radial-gradient(circle at center, #d0d6e2 0%, #bdc3c7 100%);
    color: var(--fg-primary);
    overflow: hidden;
  }

  /* Container Principal */
  .wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: 32px;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  /* Janela do Editor (O bloco escuro) */
  .window {
    background: var(--window-bg);
    border-radius: 12px;
    box-shadow: 
      0 20px 60px rgba(0,0,0,0.55),
      0 0 0 1px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 85vh;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s ease;
  }

  /* Barra de T√≠tulo / Controles */
  .titlebar {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    background: var(--window-bg);
    user-select: none;
  }

  /* Bolinhas Mac */
  .window-controls {
    display: flex;
    gap: 8px;
  }
  .dot {
    width: 12px; height: 12px;
    border-radius: 50%;
  }
  .dot.red { background: #ff5f56; }
  .dot.yellow { background: #ffbd2e; }
  .dot.green { background: #27c93f; }

  /* Barra de Ferramentas */
  .toolbar {
    display: flex;
    gap: 10px;
    margin-left: auto;
  }

  .btn {
    background: rgba(255, 255, 255, 0.05);
    border: none;
    color: var(--comment);
    padding: 8px 14px;
    border-radius: 6px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid transparent;
  }
  
  .btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--fg-primary);
    border-color: rgba(255,255,255,0.1);
  }

  .btn:active {
    transform: scale(0.96);
    background: rgba(255, 255, 255, 0.02);
  }
  
  /* Bot√£o Salvar (Rosa Dracula) */
  .btn-primary {
    background: var(--accent-pink);
    color: #282a36;
  }
  .btn-primary:hover {
    background: #ff91cf;
    color: #282a36;
    box-shadow: 0 0 15px rgba(255, 121, 198, 0.4);
  }
  .btn-primary:active {
    transform: scale(0.96);
  }

  /* Bot√£o AI (Gradiente Dracula) */
  .btn-ai {
    background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
    color: #282a36;
    font-weight: bold;
  }
  .btn-ai:hover {
    filter: brightness(1.1);
    box-shadow: 0 0 15px rgba(139, 233, 253, 0.4);
  }
  .btn-ai:active {
    transform: scale(0.96);
  }

  /* Input Nome do Arquivo */
  .filename-display {
    color: var(--fg-primary);
    font-size: 13px;
    background: rgba(0,0,0,0.2);
    border: 1px solid transparent;
    border-radius: 4px;
    text-align: center;
    width: 200px;
    padding: 4px;
    font-family: inherit;
    outline: none;
    transition: 0.2s;
  }
  .filename-display:focus {
    border-color: var(--comment);
    background: rgba(0,0,0,0.4);
  }
  .file-input { display: none; }

  /* √Årea de Texto Principal */
  .editor-container {
    flex: 1;
    position: relative;
    padding: 0;
    display: flex;
    overflow: hidden; /* Importante para o scroll funcionar corretamente */
  }
  
  /* N√∫meros de linha */
  .line-numbers {
    padding: 20px 10px 20px 20px;
    text-align: right;
    color: var(--comment);
    font-size: 15px;
    line-height: 1.6;
    user-select: none;
    opacity: 0.5;
    background: var(--window-bg);
    min-width: 50px;
    overflow: hidden;
  }

  textarea {
    flex: 1;
    width: 100%;
    height: 100%;
    background: transparent;
    border: none;
    color: var(--fg-primary);
    padding: 20px;
    font-size: 15px;
    line-height: 1.6;
    resize: none;
    outline: none;
    font-family: 'JetBrains Mono', monospace;
    white-space: pre;
    overflow-y: auto; /* Scroll apenas aqui */
    scrollbar-width: thin;
    scrollbar-color: var(--selection) transparent;
  }

  /* Rodap√© Minimalista */
  .statusbar {
    padding: 8px 20px;
    font-size: 12px;
    color: var(--comment);
    background: #21222c; /* Levemente mais escuro */
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid rgba(255,255,255,0.05);
  }
  .status-left { display: flex; gap: 15px; }
  .status-right { display: flex; gap: 15px; align-items: center; }

  .dot-status { width: 8px; height: 8px; background: var(--comment); border-radius: 50%; display: inline-block; margin-right: 6px; }
  .dot-status.active { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
  .dot-status.busy { background: var(--accent-orange); animation: pulse 0.8s infinite; }

  @keyframes pulse { 50% { opacity: 0.5; } }

  /* Modal e Overlays */
  .drop-overlay {
    position: absolute;
    inset: 10px;
    border: 2px dashed var(--accent-cyan);
    border-radius: 8px;
    background: rgba(40, 42, 54, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--accent-cyan);
    font-weight: bold;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    z-index: 50;
  }
  .drop-overlay.active { opacity: 1; pointer-events: all; }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(2px);
    z-index: 100;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--window-bg);
    padding: 30px;
    border-radius: 12px;
    border: 1px solid var(--comment);
    width: 450px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
  }
  
  .modal h2 {
    color: var(--accent-pink);
    margin-top: 0;
    font-size: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .modal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 20px;
  }

  .modal-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--comment);
    color: var(--fg-primary);
    padding: 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.2s;
    font-family: inherit;
    font-size: 13px;
    text-align: center;
  }
  .modal-btn:hover {
    border-color: var(--accent-cyan);
    color: var(--accent-cyan);
    background: rgba(139, 233, 253, 0.1);
  }

  /* Responsivo */
  @media (max-width: 600px) {
    .wrap { padding: 0; max-width: 100%; }
    .window { height: 100vh; border-radius: 0; }
    .titlebar { flex-wrap: wrap; }
    .toolbar { width: 100%; justify-content: space-between; margin-top: 10px; }
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="window">
    <!-- Titlebar -->
    <div class="titlebar">
      <div class="window-controls">
        <div class="dot red"></div>
        <div class="dot yellow"></div>
        <div class="dot green"></div>
      </div>
      <input type="text" id="fileName" class="filename-display" value="untitled.txt" spellcheck="false" placeholder="Nome do arquivo...">
      
      <div class="toolbar">
        <input type="file" id="fileInput" class="file-input">
        <button class="btn" id="btnOpen">Abrir</button>
        <button class="btn btn-primary" id="btnSave">Salvar</button>
        <button class="btn btn-ai" id="btnAi">AI ‚ú®</button>
      </div>
    </div>

    <!-- Editor -->
    <div class="editor-container">
      <div class="line-numbers" id="lineNumbers">1</div>
      <textarea id="editor" spellcheck="false" placeholder="// Digite seu c√≥digo ou texto aqui..."></textarea>
      
      <div class="drop-overlay" id="dropZone">
        SOLTE O ARQUIVO AQUI
      </div>
    </div>

    <!-- Statusbar -->
    <div class="statusbar">
      <div class="status-left">
        <span id="charCount">0 chars</span>
      </div>
      <div class="status-right">
        <div class="dot-status active" id="statusDot"></div>
        <span id="statusMsg" style="color: var(--accent-green)">Ready</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal IA -->
<div class="modal-overlay" id="aiModal">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2><span>‚ú®</span> AI Assistant</h2>
      <button id="closeAi" style="background:none; border:none; color:var(--comment); cursor:pointer; font-size:24px;">&times;</button>
    </div>
    <p style="color: var(--comment); font-size: 14px; margin-bottom: 20px;">Use a intelig√™ncia do Google Gemini 2.5 para melhorar seu c√≥digo.</p>
    
    <div class="modal-grid">
      <button class="modal-btn" onclick="runAi('fix')">Corrigir Bugs</button>
      <button class="modal-btn" onclick="runAi('refactor')">Refatorar</button>
      <button class="modal-btn" onclick="runAi('explain')">Explicar</button>
      <button class="modal-btn" onclick="runAi('convert')">Para Python</button>
    </div>
    
    <div id="loading" style="display:none; margin-top:20px; text-align:center; color:var(--accent-cyan); font-size:13px;">
      ‚ö° Processando com Gemini...
    </div>
  </div>
</div>

<script type="module">
  import { GoogleGenAI } from "@google/genai";

  // --- CONFIGURA√á√ÉO DA CHAVE ---
  // Se quiser deixar fixa para testes, coloque abaixo.
  const API_KEY_HARDCODED = ""; 

  const getApiKey = () => {
    if (API_KEY_HARDCODED) return API_KEY_HARDCODED;
    return localStorage.getItem("GEMINI_API_KEY") || "";
  };

  const API_KEY = getApiKey();
  const ai = API_KEY ? new GoogleGenAI({ apiKey: API_KEY }) : null;

  // --- Elementos ---
  const $ = (id) => document.getElementById(id);
  const editor = $("editor");
  const lineNumbers = $("lineNumbers");
  const fileName = $("fileName");
  const statusMsg = $("statusMsg");
  const statusDot = $("statusDot");
  const charCount = $("charCount");

  // --- L√≥gica do Editor ---
  const updateLines = () => {
    const lines = editor.value.split('\n').length;
    lineNumbers.innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>');
  };

  const updateStatus = (msg, type = 'normal') => {
    statusMsg.textContent = msg;
    statusDot.className = 'dot-status ' + (type === 'busy' ? 'busy' : 'active');
    statusMsg.style.color = type === 'busy' ? 'var(--accent-orange)' : 'var(--accent-green)';
  };

  // Sincronia de Scroll e Linhas
  editor.addEventListener('input', () => {
    updateLines();
    charCount.textContent = editor.value.length + " chars";
    updateStatus("Editando...");
  });

  editor.addEventListener('scroll', () => {
    lineNumbers.scrollTop = editor.scrollTop;
  });

  // --- Bot√µes ---

  // 1. Abrir Arquivo
  $("btnOpen").addEventListener('click', () => {
    // Reseta o value para garantir que o evento 'change' dispare mesmo se escolher o mesmo arquivo
    $("fileInput").value = ''; 
    $("fileInput").click();
  });
  
  $("fileInput").addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    try {
      editor.value = await file.text();
      fileName.value = file.name;
      updateLines();
      updateStatus("Arquivo carregado");
    } catch(err) {
      alert("Erro ao ler arquivo: " + err);
    }
  });

  // 2. Salvar Arquivo (CORRIGIDO)
  $("btnSave").addEventListener('click', () => {
    try {
      const content = editor.value;
      const name = fileName.value.trim() || "untitled.txt";
      
      const blob = new Blob([content], {type: "text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      
      // Essencial para Firefox e compatibilidade geral
      document.body.appendChild(a);
      a.click();
      
      // Limpeza
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 100);
      
      updateStatus("Salvo com sucesso!");
    } catch (e) {
      alert("Erro ao salvar: " + e.message);
    }
  });

  // --- Drag & Drop ---
  const dropZone = $("dropZone");
  window.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('active'); });
  window.addEventListener('dragleave', (e) => { 
    if(e.target === dropZone) dropZone.classList.remove('active'); 
  });
  window.addEventListener('drop', async (e) => {
    e.preventDefault();
    dropZone.classList.remove('active');
    const file = e.dataTransfer.files[0];
    if(file) {
      editor.value = await file.text();
      fileName.value = file.name;
      updateLines();
      updateStatus("Arquivo solto aqui");
    }
  });

  // --- L√≥gica da IA ---
  const aiModal = $("aiModal");
  const loading = $("loading");

  $("btnAi").addEventListener('click', () => {
    if(!API_KEY) {
      const key = prompt("Para usar a IA, insira sua chave da API Google Gemini:");
      if(key) {
        localStorage.setItem("GEMINI_API_KEY", key);
        alert("Chave salva! Recarregue a p√°gina para aplicar.");
        location.reload();
      }
      return;
    }
    aiModal.classList.add('open');
  });

  $("closeAi").addEventListener('click', () => aiModal.classList.remove('open'));

  // Fun√ß√£o Global para ser chamada pelos bot√µes do modal
  window.runAi = async (action) => {
    if(!editor.value.trim()) return alert("O editor est√° vazio!");
    
    loading.style.display = 'block';
    updateStatus("IA Processando...", "busy");
    
    let promptText = "";
    const code = editor.value;

    switch(action) {
      case 'fix': promptText = "Fix bugs, typos and improve syntax in the following code/text. Output ONLY the fixed code/text:\n\n" + code; break;
      case 'refactor': promptText = "Refactor this code to be cleaner and more efficient. Output ONLY the code:\n\n" + code; break;
      case 'explain': promptText = "Explain briefly what this code/text does in Portuguese:\n\n" + code; break;
      case 'convert': promptText = "Convert this code to Python. Output ONLY the Python code:\n\n" + code; break;
    }

    try {
      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash',
        contents: promptText
      });
      
      const result = response.text;
      
      if(action === 'explain') {
        // Se for explica√ß√£o, comenta no topo
        editor.value = "/* ü§ñ EXPLICA√á√ÉO DA IA:\n" + result.replace(/\*\//g, "* /") + "\n*/\n\n" + code;
      } else {
        // Limpa blocos de markdown ``` se a IA retornar
        let cleanText = result;
        if (cleanText.startsWith('```')) {
          cleanText = cleanText.replace(/^```\w*\n?/, '').replace(/\n?```$/, '');
        }
        editor.value = cleanText;
      }
      
      updateLines();
      aiModal.classList.remove('open');
      updateStatus("Conclu√≠do pela IA");
    } catch(err) {
      alert("Erro na IA: " + err.message);
      updateStatus("Erro na IA");
    } finally {
      loading.style.display = 'none';
    }
  };

  // Inicializa√ß√£o
  updateLines();
</script>
</body>
</html>
